<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Flying Cow</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body {
      margin: 0;
      background: #0f172a;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      overflow: hidden;
    }
    canvas {
      background: #1e293b;
    }
  </style>
</head>
<body>

<canvas id="game" width="360" height="640"></canvas>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

// ===== GAME STATE =====
let state = "start";
let score = 0;
let bestScore = localStorage.getItem("bestScore") || 0;

// ===== COW =====
const cow = {
  x: 80,
  y: 300,
  w: 40,
  h: 40,
  vy: 0
};

const GRAVITY = 0.5;
const JUMP = -8;

// ===== PIPES =====
let pipes = [];
let PIPE_GAP = 150;
let PIPE_SPEED = 2;

// ===== EFFECTS =====
let shake = 0;

// ===== INPUT =====
function tap() {
  if (state === "start") {
    state = "play";
    reset();
  } else if (state === "play") {
    cow.vy = JUMP;
    shake = 6;
  } else if (state === "over") {
    state = "start";
  }
}

canvas.addEventListener("click", tap);
document.addEventListener("keydown", e => {
  if (e.code === "Space") tap();
});

// ===== RESET =====
function reset() {
  cow.y = 300;
  cow.vy = 0;
  pipes = [];
  score = 0;
  PIPE_SPEED = 2;
  addPipe();
}

// ===== PIPE =====
function addPipe() {
  const top = Math.random() * 200 + 60;
  pipes.push({ x: 360, y: top, passed: false });
}

// ===== UPDATE =====
function update() {
  if (state !== "play") return;

  cow.vy += GRAVITY;
  cow.y += cow.vy;

  if (cow.y < 0 || cow.y + cow.h > 640) gameOver();

  pipes.forEach(p => {
    p.x -= PIPE_SPEED;

    if (!p.passed && p.x + 50 < cow.x) {
      p.passed = true;
      score++;
      PIPE_SPEED += 0.05; // difficulty scaling
    }

    if (
      cow.x < p.x + 50 &&
      cow.x + cow.w > p.x &&
      (cow.y < p.y || cow.y + cow.h > p.y + PIPE_GAP)
    ) {
      gameOver();
    }
  });

  if (pipes[0].x < -60) pipes.shift();
  if (pipes[pipes.length - 1].x < 200) addPipe();
}

// ===== GAME OVER =====
function gameOver() {
  state = "over";
  if (score > bestScore) {
    bestScore = score;
    localStorage.setItem("bestScore", bestScore);
  }
}

// ===== DRAW =====
function draw() {
  ctx.setTransform(1,0,0,1,0,0);
  ctx.clearRect(0,0,360,640);

  if (shake > 0) {
    ctx.translate(
      (Math.random() - 0.5) * shake,
      (Math.random() - 0.5) * shake
    );
    shake *= 0.9;
  }

  // ===== COW =====
  const angle = Math.max(-0.5, Math.min(0.8, cow.vy * 0.06));
  ctx.save();
  ctx.translate(cow.x + cow.w/2, cow.y + cow.h/2);
  ctx.rotate(angle);

  ctx.fillStyle = "white";
  ctx.fillRect(-20, -20, 40, 40);

  ctx.fillStyle = "black";
  ctx.fillRect(-10, -5, 4, 4);
  ctx.fillRect(6, -5, 4, 4);
  ctx.fillRect(-4, 6, 8, 2);

  ctx.fillStyle = "white";
  ctx.fillRect(-26, -5, 6, 10);
  ctx.fillRect(20, -5, 6, 10);

  ctx.fillStyle = "#f5deb3";
  ctx.fillRect(-12, -26, 6, 6);
  ctx.fillRect(6, -26, 6, 6);

  ctx.fillStyle = "#F6D365";
  ctx.beginPath();
  ctx.moveTo(-16, -20);
  ctx.lineTo(16, -20);
  ctx.lineTo(8, -30);
  ctx.lineTo(-8, -26);
  ctx.closePath();
  ctx.fill();

  ctx.restore();

  // ===== PIPES =====
  ctx.fillStyle = "#22c55e";
  pipes.forEach(p => {
    ctx.fillRect(p.x, 0, 50, p.y);
    ctx.fillRect(p.x, p.y + PIPE_GAP, 50, 640);
  });

  // ===== UI =====
  ctx.fillStyle = "white";
  ctx.font = "20px Arial";
  ctx.textAlign = "left";
  ctx.fillText("Score: " + score, 10, 28);
  ctx.fillText("Best: " + bestScore, 10, 52);

  ctx.textAlign = "center";
  if (state === "start") {
    ctx.font = "24px Arial";
    ctx.fillText("üêÆ Flying Cow", 180, 280);
    ctx.font = "18px Arial";
    ctx.fillText("Tap to Start", 180, 320);
  }
  if (state === "over") {
    ctx.font = "24px Arial";
    ctx.fillText("Game Over", 180, 300);
    ctx.font = "18px Arial";
    ctx.fillText("Tap to restart", 180, 340);
  }
}

// ===== LOOP =====
function loop() {
  update();
  draw();
  requestAnimationFrame(loop);
}
loop();
</script>

</body>
</html>
