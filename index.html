<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FLAPPY ULTRA</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

        body {
            margin: 0;
            padding: 0;
            background: #333;
            overflow: hidden;
            touch-action: none; /* Mobilda scrollni bloklash */
            font-family: 'Press Start 2P', cursive;
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        /* UI Qatlami */
        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }

        .title {
            font-size: 40px;
            color: #fff;
            text-shadow: 4px 4px 0 #000;
            margin-bottom: 20px;
            animation: float 2s infinite ease-in-out;
        }

        .score-big {
            position: absolute;
            top: 10%;
            font-size: 60px;
            color: #fff;
            text-shadow: 3px 3px 0 #000;
            z-index: 10;
        }

        #start-screen, #game-over-screen {
            background: rgba(0, 0, 0, 0.7);
            padding: 30px;
            border-radius: 15px;
            border: 4px solid #fff;
            pointer-events: auto; /* Tugmalar ishlashi uchun */
        }

        button {
            background: #f4ce42;
            border: 2px solid #000;
            box-shadow: 4px 4px 0 #000;
            color: #000;
            font-family: 'Press Start 2P', cursive;
            font-size: 16px;
            padding: 15px 30px;
            cursor: pointer;
            margin-top: 20px;
            transition: transform 0.1s;
        }

        button:active {
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0 #000;
        }

        .hidden { display: none !important; }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
    </style>
</head>
<body>

    <canvas id="gameCanvas"></canvas>

    <div id="ui-layer">
        <div id="score-display" class="score-big hidden">0</div>

        <div id="start-screen">
            <div class="title">FLAPPY<br>ULTRA</div>
            <p style="color:#ddd; font-size:12px; line-height:1.5;">
                SPACE yoki EKRANGA BOS<br>
                ENG YAXSHI NATIJA: <span id="best-score-start">0</span>
            </p>
            <button id="start-btn">O'YINNI BOSHLASH</button>
        </div>

        <div id="game-over-screen" class="hidden">
            <div class="title" style="color:#ff4444;">GAME OVER</div>
            <div style="background:#ddedf3; padding:15px; border:2px solid #000; border-radius:5px; margin-bottom:10px;">
                <p style="color:#e86101; margin:5px;">SCORE</p>
                <p id="final-score" style="font-size:24px; color:#000; margin:5px;">0</p>
                <hr style="border:1px dashed #aaa;">
                <p style="color:#e86101; margin:5px;">BEST</p>
                <p id="best-score-end" style="font-size:24px; color:#000; margin:5px;">0</p>
                <div id="new-record" class="hidden" style="color:red; font-size:10px; margin-top:5px;">YANGI REKORD!</div>
            </div>
            <button id="restart-btn">QAYTA O'YNASH</button>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        // --- AUDIO TIZIMI (Web Audio API) ---
        // Fayl yuklamaslik uchun tovushlarni kodda sintez qilamiz
        const AudioSys = {
            ctx: new (window.AudioContext || window.webkitAudioContext)(),
            playTone: function(freq, type, duration, vol=0.1) {
                if(this.ctx.state === 'suspended') this.ctx.resume();
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = type;
                osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
                gain.gain.setValueAtTime(vol, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration);
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.start();
                osc.stop(this.ctx.currentTime + duration);
            },
            jump: function() { this.playTone(400, 'square', 0.1, 0.1); },
            score: function() { this.playTone(1000, 'sine', 0.2, 0.1); },
            hit: function() { this.playTone(100, 'sawtooth', 0.3, 0.2); }
        };

        // --- O'YIN SOZLAMALARI ---
        let frames = 0;
        const DEGREE = Math.PI / 180;
        let state = { current: 0, getReady: 0, game: 1, over: 2 };
        let score = { value: 0, best: localStorage.getItem('flappy_best') || 0 };
        let shake = 0; // Screen shake

        // Ekranni moslashtirish
        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resize);
        resize();

        // --- GRAFIK AKTIVLAR (Procedural) ---
        
        // 1. FON (Parallax)
        const bg = {
            draw: function() {
                // Osmon
                let gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
                gradient.addColorStop(0, "#70c5ce");
                gradient.addColorStop(1, "#fff");
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                // Bulutlar (Sekin)
                ctx.fillStyle = "rgba(255, 255, 255, 0.6)";
                for(let i=0; i<5; i++) {
                    let x = ((frames * 0.5) + (i * 300)) % (canvas.width + 200) - 100;
                    let y = canvas.height - 150 - (i % 2) * 100;
                    ctx.beginPath();
                    ctx.arc(x, y, 40, 0, Math.PI * 2);
                    ctx.arc(x+30, y-10, 50, 0, Math.PI * 2);
                    ctx.arc(x+60, y, 40, 0, Math.PI * 2);
                    ctx.fill();
                }

                // Shahar silueti (O'rta)
                ctx.fillStyle = "#a3e0c3";
                const buildingWidth = 60;
                const offset = (frames * 1) % buildingWidth;
                for(let i = -1; i < canvas.width / buildingWidth + 1; i++) {
                    let h = 100 + Math.sin(i * 132) * 50;
                    ctx.fillRect(i * buildingWidth - offset, canvas.height - 120 - h, buildingWidth + 1, h);
                }
            }
        };

        // 2. YER (Tez harakatlanadi)
        const fg = {
            h: 120,
            draw: function() {
                ctx.fillStyle = "#ded895";
                ctx.fillRect(0, canvas.height - this.h, canvas.width, this.h);
                
                // Chim
                ctx.fillStyle = "#73bf2e";
                ctx.fillRect(0, canvas.height - this.h, canvas.width, 15);
                ctx.strokeStyle = "#5a9e1e";
                ctx.beginPath();
                ctx.moveTo(0, canvas.height - this.h + 15);
                ctx.lineTo(canvas.width, canvas.height - this.h + 15);
                ctx.stroke();

                // Chiziqlar (Harakat effekti)
                ctx.fillStyle = "#cbb968";
                const speed = state.current == state.game ? 3 : 0;
                const offset = (frames * speed) % 20;
                for(let i = -1; i < canvas.width / 20 + 1; i++) {
                    ctx.beginPath();
                    ctx.moveTo(i * 20 - offset, canvas.height - this.h + 5);
                    ctx.lineTo(i * 20 - 10 - offset, canvas.height - this.h + 25);
                    ctx.lineTo(i * 20 - 5 - offset, canvas.height - this.h + 25);
                    ctx.lineTo(i * 20 + 5 - offset, canvas.height - this.h + 5);
                    ctx.fill();
                }
            }
        };

        // 3. QUSH (Vektor)
        const bird = {
            x: 50,
            y: 150,
            w: 34,
            h: 24,
            radius: 12,
            frame: 0,
            gravity: 0.25,
            jump: 4.6,
            speed: 0,
            rotation: 0,
            
            draw: function() {
                let birdY = this.y;
                // Get Ready holatida tebranish
                if(state.current == state.getReady) {
                    birdY += Math.cos(frames/10) * 5;
                }

                ctx.save();
                ctx.translate(this.x, birdY);
                
                // Aylanish fizikasi
                if(state.current == state.game) {
                    if(this.speed < this.jump/2) this.rotation = -25 * DEGREE;
                    else {
                        this.rotation += 2 * DEGREE;
                        this.rotation = Math.min(this.rotation, 90 * DEGREE);
                    }
                } else {
                    this.rotation = 0;
                }
                ctx.rotate(this.rotation);

                // Tana
                ctx.fillStyle = "#f4ce42"; // Sariq
                ctx.beginPath();
                ctx.ellipse(0, 0, this.radius+5, this.radius, 0, 0, Math.PI*2);
                ctx.fill();
                ctx.lineWidth = 2;
                ctx.strokeStyle = "#000";
                ctx.stroke();

                // Ko'z
                ctx.fillStyle = "#fff";
                ctx.beginPath();
                ctx.arc(6, -6, 8, 0, Math.PI*2);
                ctx.fill();
                ctx.stroke();
                ctx.fillStyle = "#000"; // Qorachiq
                ctx.beginPath();
                ctx.arc(8, -6, 2, 0, Math.PI*2);
                ctx.fill();

                // Tumshuq
                ctx.fillStyle = "#e86101";
                ctx.beginPath();
                ctx.moveTo(8, 2);
                ctx.lineTo(16, 6);
                ctx.lineTo(8, 10);
                ctx.fill();
                ctx.stroke();

                // Qanot (Harakatlanadi)
                ctx.fillStyle = "#fff";
                const flap = state.current == state.game ? Math.sin(frames * 0.5) * 5 : 0;
                ctx.beginPath();
                ctx.ellipse(-5, 5 + flap, 8, 5, 0, 0, Math.PI*2);
                ctx.fill();
                ctx.stroke();

                ctx.restore();
            },
            
            flap: function() {
                this.speed = -this.jump;
                // Partikllar (patlar) chiqarish
                particles.spawn(this.x, this.y, "#fff", 3);
            },
            
            update: function() {
                // Fizika (O'yin paytida)
                if(state.current == state.game) {
                    this.speed += this.gravity;
                    this.y += this.speed;

                    // Yerga urilish
                    if(this.y + this.h/2 >= canvas.height - fg.h) {
                        this.y = canvas.height - fg.h - this.h/2;
                        gameOver();
                    }
                    
                    // Shiftga urilish
                    if(this.y < 0) this.y = 0;
                }
            },
            reset: function() {
                this.y = canvas.height / 2;
                this.speed = 0;
                this.rotation = 0;
                this.x = canvas.width / 4; // Mobilga moslashish
            }
        };

        // 4. QUVURLAR
        const pipes = {
            position: [],
            w: 60, // Quvur kengligi
            h: 0,  // O'zgaruvchan
            gap: 120, // Teshik kattaligi
            dx: 3, // Tezlik (Dinamik o'sadi)

            draw: function() {
                for(let i=0; i<this.position.length; i++) {
                    let p = this.position[i];
                    let topY = p.y;
                    let bottomY = p.y + this.gap;

                    // Gradient effekti (3D Quvur)
                    let grad = ctx.createLinearGradient(p.x, 0, p.x + this.w, 0);
                    grad.addColorStop(0, "#558022");
                    grad.addColorStop(0.5, "#73bf2e");
                    grad.addColorStop(1, "#558022");
                    ctx.fillStyle = grad;
                    
                    // Chegara
                    ctx.strokeStyle = "#000";
                    ctx.lineWidth = 2;

                    // Tepdagi quvur
                    ctx.fillRect(p.x, 0, this.w, topY);
                    ctx.strokeRect(p.x, 0, this.w, topY);
                    // Qopqog'i
                    ctx.fillRect(p.x - 2, topY - 20, this.w + 4, 20);
                    ctx.strokeRect(p.x - 2, topY - 20, this.w + 4, 20);

                    // Pastki quvur
                    ctx.fillRect(p.x, bottomY, this.w, canvas.height - fg.h - bottomY);
                    ctx.strokeRect(p.x, bottomY, this.w, canvas.height - fg.h - bottomY);
                    // Qopqog'i
                    ctx.fillRect(p.x - 2, bottomY, this.w + 4, 20);
                    ctx.strokeRect(p.x - 2, bottomY, this.w + 4, 20);
                }
            },

            update: function() {
                if(state.current !== state.game) return;

                // Har 100 kadrda yangi quvur
                if(frames % 100 == 0) {
                    // Balandlikni hisoblash (Murakkabroq)
                    const min = canvas.height * 0.1;
                    const max = canvas.height - fg.h - this.gap - min;
                    this.position.push({
                        x: canvas.width,
                        y: Math.random() * (max - min) + min,
                        passed: false
                    });
                }

                for(let i=0; i<this.position.length; i++) {
                    let p = this.position[i];
                    p.x -= this.dx;

                    // To'qnashuv (Collision) - Eng muhim qism
                    let birdLeft = bird.x - bird.radius + 5; // Hitbox biroz kichikroq (fair play)
                    let birdRight = bird.x + bird.radius - 5;
                    let birdTop = bird.y - bird.radius + 5;
                    let birdBottom = bird.y + bird.radius - 5;

                    let pipeLeft = p.x;
                    let pipeRight = p.x + this.w;
                    let topPipeBottom = p.y;
                    let bottomPipeTop = p.y + this.gap;

                    // Quvur ichidami?
                    if(birdRight > pipeLeft && birdLeft < pipeRight) {
                        // Tepa yoki pastga tegdimi?
                        if(birdTop < topPipeBottom || birdBottom > bottomPipeTop) {
                            gameOver();
                        }
                    }

                    // Ochko olish
                    if(p.x + this.w < bird.x && !p.passed) {
                        score.value += 1;
                        p.passed = true;
                        AudioSys.score();
                        
                        // Qiyinlashish: Har 5 ochkoda tezlik oshadi
                        if(score.value % 5 == 0) this.dx += 0.2;
                    }

                    // O'chirish
                    if(p.x + this.w <= 0) {
                        this.position.shift();
                        i--; // Array buzilmasligi uchun
                    }
                }
            },
            reset: function() {
                this.position = [];
                this.dx = 3;
            }
        };

        // 5. PARTIKLLAR (Effektlar)
        const particles = {
            data: [],
            spawn: function(x, y, color, count) {
                for(let i=0; i<count; i++) {
                    this.data.push({
                        x: x, y: y,
                        vx: (Math.random() - 0.5) * 5,
                        vy: (Math.random() - 0.5) * 5,
                        life: 1.0,
                        color: color
                    });
                }
            },
            draw: function() {
                for(let i=this.data.length-1; i>=0; i--) {
                    let p = this.data[i];
                    p.x += p.vx;
                    p.y += p.vy;
                    p.vy += 0.2; // Gravity
                    p.life -= 0.05;

                    if(p.life <= 0) {
                        this.data.splice(i, 1);
                        continue;
                    }

                    ctx.globalAlpha = p.life;
                    ctx.fillStyle = p.color;
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, 3, 0, Math.PI*2);
                    ctx.fill();
                    ctx.globalAlpha = 1.0;
                }
            },
            reset: function() { this.data = []; }
        };

        // --- O'YIN LOGIKASI ---

        function gameOver() {
            state.current = state.over;
            shake = 20; // Ekran titrashi
            AudioSys.hit();
            particles.spawn(bird.x, bird.y, "#e86101", 20); // Portlash
            
            // UI yangilash
            const isBest = score.value > score.best;
            if(isBest) {
                score.best = score.value;
                localStorage.setItem('flappy_best', score.best);
            }
            
            document.getElementById('final-score').innerText = score.value;
            document.getElementById('best-score-end').innerText = score.best;
            document.getElementById('new-record').classList.toggle('hidden', !isBest);
            
            document.getElementById('score-display').classList.add('hidden');
            document.getElementById('game-over-screen').classList.remove('hidden');
        }

        function startGame() {
            state.current = state.game;
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('score-display').classList.remove('hidden');
            bird.flap();
            AudioSys.jump();
        }

        function resetGame() {
            bird.reset();
            pipes.reset();
            particles.reset();
            score.value = 0;
            document.getElementById('score-display').innerText = 0;
            state.current = state.getReady;
            
            document.getElementById('game-over-screen').classList.add('hidden');
            document.getElementById('start-screen').classList.remove('hidden');
            document.getElementById('best-score-start').innerText = score.best;
        }

        // --- MAIN LOOP ---
        function loop() {
            // Fizika va Logika
            bird.update();
            pipes.update();
            
            // Screen Shake (Titroq) logikasi
            ctx.save();
            if(shake > 0) {
                let dx = (Math.random() - 0.5) * shake;
                let dy = (Math.random() - 0.5) * shake;
                ctx.translate(dx, dy);
                shake *= 0.9; // So'nish
            }

            // Chizish (Qatlamlar)
            bg.draw();
            pipes.draw();
            fg.draw();
            bird.draw();
            particles.draw();
            
            ctx.restore();

            // Score HUD (O'yin paytida)
            if(state.current == state.game) {
                document.getElementById('score-display').innerText = score.value;
            }

            frames++;
            requestAnimationFrame(loop);
        }

        // --- INPUT ---
        document.addEventListener("keydown", function(e) {
            if(e.code === "Space") handleInput();
        });
        document.addEventListe
