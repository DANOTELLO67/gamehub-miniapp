<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Flappy Cyberpunk Pro</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;900&display=swap');
        
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Orbitron', sans-serif; }
        canvas { display: block; filter: drop-shadow(0 0 10px #00f2ff); }

        #ui {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            pointer-events: none; color: #fff;
        }

        .score-box { position: absolute; top: 40px; font-size: 60px; font-weight: 900; color: #00f2ff; text-shadow: 0 0 20px #00f2ff; }
        .hint { font-size: 18px; margin-top: 200px; animation: blink 1s infinite; text-transform: uppercase; }
        
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.2; } }

        #leaderboard {
            position: absolute; bottom: 20px; font-size: 14px; color: rgba(255,255,255,0.5);
        }
    </style>
</head>
<body>

    <div id="ui">
        <div class="score-box" id="score">0</div>
        <div id="start-screen">
            <h1 style="font-size: 30px; color: #ff00ff; text-shadow: 0 0 15px #ff00ff;">CYBER BIRD</h1>
            <div class="hint">TAP TO START</div>
        </div>
    </div>

    <canvas id="gameCanvas"></canvas>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreEl = document.getElementById('score');
        const startScreen = document.getElementById('start-screen');

        // --- GAME ASSETS (SOUNDS) ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(freq, type, duration) {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + duration);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + duration);
        }

        // --- SETTINGS ---
        let w, h, raf;
        let gameState = 'START';
        let score = 0;
        let frame = 0;

        function resize() {
            w = canvas.width = window.innerWidth;
            h = canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resize);
        resize();

        // --- OBJECTS ---
        let bird = {
            x: 80, y: h/2, radius: 15, 
            velocity: 0, gravity: 0.25, jump: -6,
            rotation: 0, color: '#00f2ff'
        };

        let pipes = [];
        let particles = [];

        class Particle {
            constructor(x, y, color) {
                this.x = x; this.y = y;
                this.vx = (Math.random() - 0.5) * 5;
                this.vy = (Math.random() - 0.5) * 5;
                this.alpha = 1;
                this.color = color;
            }
            update() { this.x += this.vx; this.y += this.vy; this.alpha -= 0.02; }
            draw() {
                ctx.globalAlpha = this.alpha;
                ctx.shadowBlur = 10; ctx.shadowColor = this.color;
                ctx.fillStyle = this.color;
                ctx.fillRect(this.x, this.y, 4, 4);
                ctx.globalAlpha = 1; ctx.shadowBlur = 0;
            }
        }

        function createPipe() {
            let gap = 160;
            let minH = 100;
            let pipeH = Math.random() * (h - gap - (minH * 2)) + minH;
            pipes.push({ x: w, top: pipeH, bottom: h - pipeH - gap, passed: false });
        }

        // --- GAME LOOP ---
        function update() {
            if (gameState === 'PLAY') {
                frame++;
                bird.velocity += bird.gravity;
                bird.y += bird.velocity;
                bird.rotation = Math.min(Math.PI/4, Math.max(-Math.PI/4, bird.velocity * 0.1));

                if (frame % 100 === 0) createPipe();

                pipes.forEach((p, i) => {
                    p.x -= 3.5;
                    
                    // Collision
                    if (bird.x + bird.radius > p.x && bird.x - bird.radius < p.x + 60) {
                        if (bird.y - bird.radius < p.top || bird.y + bird.radius > h - p.bottom) {
                            gameOver();
                        }
                    }

                    if (p.x + 60 < bird.x && !p.passed) {
                        score++;
                        p.passed = true;
                        scoreEl.innerText = score;
                        playSound(800, 'square', 0.1);
                        tg.HapticFeedback.impactOccurred('light');
                        // Change skin color
                        if(score % 5 === 0) bird.color = `hsl(${Math.random()*360}, 100%, 50%)`;
                    }
                });

                if (pipes.length > 0 && pipes[0].x < -100) pipes.shift();
                if (bird.y + bird.radius > h || bird.y - bird.radius < 0) gameOver();

                // Particle trail
                if (frame % 2 === 0) particles.push(new Particle(bird.x - 10, bird.y, bird.color));
            }

            particles.forEach((p, i) => {
                p.update();
                if (p.alpha <= 0) particles.splice(i, 1);
            });
        }

        function draw() {
            // Background (Cyberpunk Gradient)
            let grad = ctx.createLinearGradient(0, 0, 0, h);
            grad.addColorStop(0, '#0a0a2e');
            grad.addColorStop(1, '#000000');
            ctx.fillStyle = grad;
            ctx.fillRect(0, 0, w, h);

            // Gridlines (Moving effect)
            ctx.strokeStyle = 'rgba(0, 242, 255, 0.05)';
            ctx.lineWidth = 1;
            let scroll = (frame * 2) % 50;
            for(let i = -scroll; i < w; i += 50) {
                ctx.beginPath(); ctx.moveTo(i, 0); ctx.lineTo(i, h); ctx.stroke();
            }

            particles.forEach(p => p.draw());

            // Pipes
            pipes.forEach(p => {
                ctx.shadowBlur = 15; ctx.shadowColor = '#ff00ff';
                ctx.fillStyle = '#111';
                ctx.strokeStyle = '#ff00ff';
                ctx.lineWidth = 3;
                
                // Top pipe
                ctx.fillRect(p.x, 0, 60, p.top);
                ctx.strokeRect(p.x, -10, 60, p.top + 10);
                
                // Bottom pipe
                ctx.fillRect(p.x, h - p.bottom, 60, p.bottom);
                ctx.strokeRect(p.x, h - p.bottom, 60, p.bottom + 10);
                ctx.shadowBlur = 0;
            });

            // Bird
            ctx.save();
            ctx.translate(bird.x, bird.y);
            ctx.rotate(bird.rotation);
            ctx.shadowBlur = 20; ctx.shadowColor = bird.color;
            ctx.fillStyle = bird.color;
            ctx.beginPath();
            ctx.arc(0, 0, bird.radius, 0, Math.PI * 2);
            ctx.fill();
            // Eye
            ctx.fillStyle = '#fff';
            ctx.beginPath(); ctx.arc(7, -5, 5, 0, Math.PI * 2); ctx.fill();
            ctx.fillStyle = '#000';
            ctx.beginPath(); ctx.arc(9, -5, 2, 0, Math.PI * 2); ctx.fill();
            ctx.restore();
        }

        function loop() {
            update();
            draw();
            raf = requestAnimationFrame(loop);
        }

        function gameOver() {
            gameState = 'OVER';
            playSound(150, 'sawtooth', 0.5);
            tg.HapticFeedback.notificationOccurred('error');
            
            // Death particles
            for(let i=0; i<20; i++) particles.push(new Particle(bird.x, bird.y, bird.color));
            
            setTimeout(() => {
                reset();
            }, 1500);
        }

        function reset() {
            bird.y = h/2; bird.velocity = 0; bird.color = '#00f2ff';
            pipes = []; particles = []; score = 0; frame = 0;
            scoreEl.innerText = '0';
            gameState = 'START';
            startScreen.style.display = 'block';
        }

        // --- INPUT ---
        function handleAction() {
            if (gameState === 'START') {
                gameState = 'PLAY';
                startScreen.style.display = 'none';
                audioCtx.resume();
            }
            if (gameState === 'PLAY') {
                bird.velocity = bird.jump;
                playSound(400, 'triangle', 0.1);
                tg.HapticFeedback.impactOccurred('soft');
            }
        }

        window.addEventListener('mousedown', (e) => { e.preventDefault(); handleAction(); });
        window.addEventListener('touchstart', (e) => { e.preventDefault(); handleAction(); }, {passive: false});

        loop();
    </script>
</body>
    </html>
    
