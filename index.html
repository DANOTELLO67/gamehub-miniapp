<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>STREET KINGS: DAYLIGHT (NFS STYLE)</title>
    <style>
        body { margin: 0; overflow: hidden; background: #1a1a1a; font-family: 'Arial Black', sans-serif; user-select: none; }
        canvas { display: block; width: 100%; height: 100%; }

        /* UI INTERFEYS (NFS MW Style) */
        #hud {
            position: absolute; bottom: 30px; right: 30px; text-align: right;
            pointer-events: none; color: #ffaa00; text-transform: uppercase;
            text-shadow: 2px 2px 0px #000;
        }
        #speed-box { font-style: italic; }
        #speed-value { font-size: 100px; font-weight: 900; letter-spacing: -3px; color: #fff; }
        #speed-unit { font-size: 30px; color: #ffaa00; }
        
        #tachometer-bar {
            width: 350px; height: 15px; background: #222; margin-top: 10px;
            transform: skewX(-30deg); overflow: hidden; border: 2px solid #000;
        }
        #rpm-fill {
            width: 0%; height: 100%; background: linear-gradient(90deg, #ffaa00, #ff4400);
            transition: width 0.1s linear;
        }

        /* LOADING SCREEN */
        #loading {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; display: flex; justify-content: center; align-items: center;
            flex-direction: column; z-index: 999;
        }
        #loading-text {
            color: #ffaa00; font-size: 24px; margin-top: 20px; letter-spacing: 2px;
        }
        .loader-bar {
            width: 300px; height: 5px; background: #333; margin-top: 20px;
        }
        #loader-progress {
            width: 0%; height: 100%; background: #ffaa00; transition: width 0.3s;
        }

        /* Mobile Controls */
        .mobile-btn {
            position: absolute; width: 90px; height: 90px; background: rgba(0,0,0,0.5);
            border: 3px solid #ffaa00; border-radius: 50%;
            display: none; justify-content: center; align-items: center; font-size: 30px; color: #ffaa00;
        }
        .mobile-btn:active { background: rgba(255, 170, 0, 0.3); color: white; }
        #btn-left { bottom: 30px; left: 20px; }
        #btn-right { bottom: 30px; left: 120px; }
        #btn-brake { bottom: 30px; right: 20px; border-color: #ff4400; color: #ff4400; }
        #btn-gas { bottom: 130px; right: 20px; }

    </style>
</head>
<body>

    <div id="loading">
        <div style="color: #ffaa00; font-size: 40px; font-weight: bold;">STREET KINGS</div>
        <div id="loading-text">YUKLANMOQDA: HD MODELLAR...</div>
        <div class="loader-bar"><div id="loader-progress"></div></div>
    </div>

    <div id="hud">
        <div id="speed-box">
            <span id="speed-value">0</span> <span id="speed-unit">KM/H</span>
        </div>
        <div id="tachometer-bar"><div id="rpm-fill"></div></div>
    </div>

    <div id="btn-left" class="mobile-btn">â—€</div>
    <div id="btn-right" class="mobile-btn">â–¶</div>
    <div id="btn-brake" class="mobile-btn">ðŸ›‘</div>
    <div id="btn-gas" class="mobile-btn">â–²</div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { RGBELoader } from 'three/addons/loaders/RGBELoader.js';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import { ShaderPass } from 'three/addons/postprocessing/ShaderPass.js';
        import { GammaCorrectionShader } from 'three/addons/shaders/GammaCorrectionShader.js';
        import { FXAAShader } from 'three/addons/shaders/FXAAShader.js';

        const IS_MOBILE = /Android|iPhone|iPad/i.test(navigator.userAgent);
        if (IS_MOBILE) document.querySelectorAll('.mobile-btn').forEach(btn => btn.style.display = 'flex');

        // --- SAHNA VA RENDERER ---
        const scene = new THREE.Scene();
        // NFS MW uslubidagi sarg'ish tuman
        scene.fog = new THREE.FogExp2(0x998866, 0.008);

        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 2000);
        camera.position.set(0, 3, -7);

        const renderer = new THREE.WebGLRenderer({ antialias: false, powerPreference: "high-performance", stencil: false });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio); // Full HD tiniqlik
        renderer.shadowMap.enabled = true; // Haqiqiy soyalar
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        // Realistik ranglar (ACES Filmic)
        renderer.toneMapping = THREE.ACESFilmicToneMapping;
        renderer.toneMappingExposure = 1.2;
        renderer.outputColorSpace = THREE.SRGBColorSpace;
        document.body.appendChild(renderer.domElement);

        // --- YORITISH (Kunduzgi) ---
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.4);
        scene.add(ambientLight);

        // Quyosh (Soya tushiradi)
        const sunLight = new THREE.DirectionalLight(0xfff0dd, 1.5);
        sunLight.position.set(100, 150, -100);
        sunLight.castShadow = true;
        sunLight.shadow.mapSize.width = 2048; // HD Soya
        sunLight.shadow.mapSize.height = 2048;
        sunLight.shadow.camera.near = 0.5;
        sunLight.shadow.camera.far = 500;
        sunLight.shadow.camera.left = -100; sunLight.shadow.camera.right = 100;
        sunLight.shadow.camera.top = 100; sunLight.shadow.camera.bottom = -100;
        scene.add(sunLight);

        // --- ASSETS YUKLASH MANAGER ---
        const loadingManager = new THREE.LoadingManager();
        const progressBar = document.getElementById('loader-progress');
        loadingManager.onProgress = (url, loaded, total) => {
            progressBar.style.width = (loaded / total * 100) + '%';
        };
        loadingManager.onLoad = () => {
            document.getElementById('loading').style.display = 'none';
        };

        const textureLoader = new THREE.TextureLoader(loadingManager);
        const gltfLoader = new GLTFLoader(loadingManager);
        const rgbeLoader = new RGBELoader(loadingManager);

        // --- DUNYO QURISH ---
        
        // 1. HDRI Environment (Real osmon va refleksiya)
        // PolyHaven dan kunduzgi sanoat zonasi xaritasi
        rgbeLoader.load('https://dl.polyhaven.org/file/ph-assets/HDRIs/hdr/1k/industrial_sunset_puresky_1k.hdr', function (texture) {
            texture.mapping = THREE.EquirectangularReflectionMapping;
            scene.environment = texture;
            // scene.background = texture; // Orqa fonni tuman bilan qoplaymiz
        });

        // 2. Yo'l (HD Teksturalar bilan)
        // Internetdan og'ir teksturalarni yuklaymiz
        const roadBase = textureLoader.load('https://raw.githubusercontent.com/mrdoob/three.js/dev/examples/textures/terrain/grasslight-big.jpg');
        const roadNormal = textureLoader.load('https://raw.githubusercontent.com/mrdoob/three.js/dev/examples/textures/water/Water_1_M_Normal.jpg'); // Asfalt yorig'i uchun
        
        roadBase.wrapS = roadBase.wrapT = THREE.RepeatWrapping;
        roadBase.repeat.set(5, 100);
        roadNormal.wrapS = roadNormal.wrapT = THREE.RepeatWrapping;
        roadNormal.repeat.set(5, 100);

        const roadGeo = new THREE.PlaneGeometry(40, 2000);
        const roadMat = new THREE.MeshStandardMaterial({ 
            map: roadBase,
            normalMap: roadNormal, // Haqiqiy g'adir-budurlik
            roughness: 0.8,
            color: 0x555555 
        });
        const road = new THREE.Mesh(roadGeo, roadMat);
        road.rotation.x = -Math.PI / 2;
        road.receiveShadow = true; // Soya qabul qiladi
        scene.add(road);

        // 3. Atrof-muhit (Binolar va Sanoat obyektlari)
        const buildings = [];
        const concreteTex = textureLoader.load('https://raw.githubusercontent.com/mrdoob/three.js/dev/examples/textures/brick_diffuse.jpg');
        concreteTex.wrapS = concreteTex.wrapT = THREE.RepeatWrapping;

        const buildGeo = new THREE.BoxGeometry(1,1,1);
        const buildMat = new THREE.MeshStandardMaterial({ 
            map: concreteTex, roughness: 0.9, color: 0x887766
        });

        for(let i=0; i<150; i++) {
            const h = Math.random() * 30 + 10;
            const w = Math.random() * 10 + 5;
            const d = Math.random() * 10 + 5;
            const building = new THREE.Mesh(buildGeo, buildMat);
            building.position.set(
                (Math.random() > 0.5 ? 1 : -1) * (25 + Math.random()*30), 
                h/2, 
                Math.random() * -800
            );
            building.scale.set(w, h, d);
            building.castShadow = true;
            building.receiveShadow = true;
            scene.add(building);
            buildings.push(building);
        }

        // --- MASHINA YUKLASH (Internetdan Model) ---
        let playerCar = new THREE.Group();
        scene.add(playerCar);

        // Three.js misollaridan bepul sport mashina modelini yuklaymiz
        // Bu model og'ir, shuning uchun yuklanishini kutish kerak.
        gltfLoader.load('https://raw.githubusercontent.com/mrdoob/three.js/dev/examples/models/gltf/Ferrari/Ferrari.glb', function (gltf) {
            const carModel = gltf.scene;
            carModel.scale.set(0.015, 0.015, 0.015); // Model masshtabini to'g'irlash
            carModel.position.set(0, 0, 0);
            carModel.rotation.y = Math.PI; // Oldinga qaratish

            // Materiallarni NFS uslubiga moslash (Qora metallik)
            carModel.traverse((child) => {
                if (child.isMesh) {
                    child.castShadow = true;
                    child.receiveShadow = true;
                    if (child.material.name.includes("Body")) {
                        child.material.color.setHex(0x111111); // Qora rang
                        child.material.metalness = 0.9;
                        child.material.roughness = 0.1; // Yaltiroq
                        child.material.envMapIntensity = 1.5; // Kuchli refleksiya
                    }
                }
            });
            playerCar.add(carModel);
        });

        // Trafik (Oddiyroq modellar)
        const traffic = [];
        const trafficGeo = new THREE.BoxGeometry(3, 2, 6);
        const trafficMat = new THREE.MeshStandardMaterial({color: 0x444444});
        for(let i=0; i<15; i++) {
            const tCar = new THREE.Mesh(trafficGeo, trafficMat);
            tCar.position.set(
                (Math.random()-0.5) * 30,
                1,
                -100 - Math.random() * 600
            );
            tCar.castShadow = true;
            scene.add(tCar);
            traffic.push({ mesh: tCar, speed: 30 + Math.random() * 30 });
        }

        // --- POST PROCESSING (NFS FILTER) ---
        const composer = new EffectComposer(renderer);
        composer.addPass(new RenderPass(scene,camera));
        
        // Ranglarni to'g'irlash (Gamma)
        composer.addPass(new ShaderPass(GammaCorrectionShader));
        
        // FXAA (Qirralarni silliqlash - Full HD uchun muhim)
        const fxaaPass = new ShaderPass(FXAAShader);
        fxaaPass.uniforms['resolution'].value.set(1 / window.innerWidth, 1 / window.innerHeight);
        composer.addPass(fxaaPass);

        // Sepia / Sarg'ish filtr (NFS MW Vibe)
        const SepiaShader = {
            uniforms: { "tDiffuse": { value: null }, "amount": { value: 0.8 } },
            vertexShader: `varying vec2 vUv; void main() { vUv = uv; gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 ); }`,
            fragmentShader: `uniform sampler2D tDiffuse; uniform float amount; varying vec2 vUv;
                void main() {
                    vec4 color = texture2D( tDiffuse, vUv );
                    vec3 c = color.rgb;
                    color.r = dot(c, vec3(0.393, 0.769, 0.189));
                    color.g = dot(c, vec3(0.349, 0.686, 0.168));
                    color.b = dot(c, vec3(0.272, 0.534, 0.131));
                    // Asl rang bilan aralashtirish (juda sariq bo'lmasligi uchun)
                    gl_FragColor = vec4( mix(c, color.rgb, amount * 0.4), color.a );
                }`
        };
        composer.addPass(new ShaderPass(SepiaShader));


        // --- FIZIKA VA BOSHQARUV ---
        let speed = 0;
        const maxSpeed = 320;
        const acceleration = 150;
        const braking = 200;
        const friction = 40;
        let steering = 0;
        let trackOffset = 0;

        const keys = { w: false, a: false, s: false, d: false };

        // PC Input
        window.addEventListener('keydown', (e) => {
            if(e.key === 'w' || e.key === 'ArrowUp') keys.w = true;
            if(e.key === 's' || e.key === 'ArrowDown') keys.s = true;
            if(e.key === 'a' || e.key === 'ArrowLeft') keys.a = true;
            if(e.key === 'd' || e.key === 'ArrowRight') keys.d = true;
        });
        window.addEventListener('keyup', (e) => {
            if(e.key === 'w' || e.key === 'ArrowUp') keys.w = false;
            if(e.key === 's' || e.key === 'ArrowDown') keys.s = false;
            if(e.key === 'a' || e.key === 'ArrowLeft') keys.a = false;
            if(e.key === 'd' || e.key === 'ArrowRight') keys.d = false;
        });

        // Mobile Input
        const btnLeft = document.getElementById('btn-left');
        const btnRight = document.getElementById('btn-right');
        const btnBrake = document.getElementById('btn-brake');
        const btnGas = document.getElementById('btn-gas');
        btnLeft.addEventListener('touchstart', (e)=>{e.preventDefault();keys.a=true;}); btnLeft.addEventListener('touchend', (e)=>{e.preventDefault();keys.a=false;});
        btnRight.addEventListener('touchstart', (e)=>{e.preventDefault();keys.d=true;}); btnRight.addEventListener('touchend', (e)=>{e.preventDefault();keys.d=false;});
        btnBrake.addEventListener('touchstart', (e)=>{e.preventDefault();keys.s=true;}); btnBrake.addEventListener('touchend', (e)=>{e.preventDefault();keys.s=false;});
        btnGas.addEventListener('touchstart', (e)=>{e.preventDefault();keys.w=true;}); btnGas.addEventListener('touchend', (e)=>{e.preventDefault();keys.w=false;});


        // --- GAME LOOP ---
        const clock = new THREE.Clock();
        
        function animate() {
            requestAnimationFrame(animate);
            const dt = Math.min(clock.getDelta(), 0.1);

            // Fizika
            if (keys.w) speed += acceleration * dt;
            else if (keys.s) speed -= braking * dt;
            else speed -= friction * dt;
            speed = Math.max(0, Math.min(speed, maxSpeed));

            const turnSpeed = speed > 30 ? 20 : 0;
            if (keys.a) steering -= 2.5 * dt;
            if (keys.d) steering += 2.5 * dt;
            if (!keys.a && !keys.d) steering *= 0.92;
            steering = Math.max(-1.2, Math.min(1.2, steering));

            playerCar.position.x += steering * turnSpeed * dt;
            
            // Body Roll (Mashina og'ishi)
            if(playerCar.children.length > 0) {
                 playerCar.children[0].rotation.z = -steering * 0.08;
                 playerCar.children[0].rotation.y = Math.PI + steering * 0.1;
            }

            // Cheksiz yo'l harakati
            const moveDist = speed * dt;
            trackOffset += moveDist;
            roadBase.offset.y -= moveDist * 0.02;
            roadNormal.offset.y -= moveDist * 0.02;

            buildings.forEach(b => {
                b.position.z += moveDist;
                if (b.position.z > 50) {
                    b.position.z -= 800;
                    b.position.x = (Math.random() > 0.5 ? 1 : -1) * (25 + Math.random()*30);
                }
            });

            traffic.forEach(t => {
                const relativeSpeed = speed - t.speed;
                t.mesh.position.z += relativeSpeed * dt;
                if (t.mesh.position.z > 50) {
                    t.mesh.position.z = -600 - Math.random() * 400;
                    t.mesh.position.x = (Math.random() - 0.5) * 30;
                }
            });

            // Kamera (Dinamik)
            const targetCamZ = 6 + (speed / maxSpeed) * 4;
            const targetCamY = 3 - (speed / maxSpeed) * 0.8;
            const targetFov = 75 + (speed / maxSpeed) * 20;
            camera.position.z = THREE.MathUtils.lerp(camera.position.z, targetCamZ, dt * 3);
            camera.position.y = THREE.MathUtils.lerp(camera.position.y, targetCamY, dt * 3);
            camera.position.x = THREE.MathUtils.lerp(camera.position.x, playerCar.position.x * 0.7, dt * 4);
            camera.fov = THREE.MathUtils.lerp(camera.fov, targetFov, dt * 2);
            camera.lookAt(playerCar.position.x, 1, playerCar.position.z - 10);
            camera.updateProjectionMatrix();

            // HUD Update
            document.getElementById('speed-value').innerText = Math.floor(speed);
            document.getElementById('rpm-fill').style.width = (speed / maxSpeed * 100) + '%';

            // Render (Composer orqali)
            composer.render();
        }

        animate();

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            composer.setSize(window.innerWidth, window.innerHeight);
            fxaaPass.uniforms['resolution'].value.set(1 / window.innerWidth, 1 / window.innerHeight);
        });
    </script>
</body>
    </html>
    
