<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Roblox Uz - Ultra Pro</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Poppins:wght@400;700&display=swap');
        
        :root { --p: #00f2ff; --bg: #08080a; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; }
        body { font-family: 'Poppins', sans-serif; background: var(--bg); color: #fff; overflow: hidden; height: 100vh; }

        /* --- UI DESIGN --- */
        #menu { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; padding: 30px; }
        .logo { font-family: 'Bebas Neue', cursive; font-size: 60px; letter-spacing: 4px; color: var(--p); text-shadow: 0 0 20px rgba(0,242,255,0.5); margin-bottom: 40px; }
        
        .btn-box { display: grid; gap: 20px; width: 100%; max-width: 300px; }
        .g-btn { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); padding: 20px; border-radius: 15px; display: flex; align-items: center; gap: 15px; transition: 0.3s; cursor: pointer; }
        .g-btn:active { transform: scale(0.95); background: rgba(0,242,255,0.1); border-color: var(--p); }
        .g-btn span { font-size: 30px; }
        .g-btn h3 { font-size: 18px; font-weight: 700; }

        /* --- ENGINE CANVAS --- */
        #stage { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: none; background: #000; }
        canvas { display: block; width: 100%; height: 100%; }
        
        .hud { position: absolute; top: 0; left: 0; width: 100%; padding: 25px; display: flex; justify-content: space-between; align-items: flex-start; pointer-events: none; z-index: 10; }
        .score-ui { font-family: 'Bebas Neue'; font-size: 50px; color: rgba(255,255,255,0.3); pointer-events: none; }
        .exit-ui { background: rgba(255,255,255,0.1); border: none; color: #fff; padding: 10px 20px; border-radius: 10px; font-weight: 700; pointer-events: auto; }
        
        .overlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; width: 100%; pointer-events: none; }
        .overlay h2 { font-family: 'Bebas Neue'; font-size: 40px; letter-spacing: 2px; }
    </style>
</head>
<body>

    <div id="menu">
        <h1 class="logo">ROBLOX UZ</h1>
        <div class="btn-box">
            <div class="g-btn" onclick="init('flappy')"><span>üê¶</span><div><h3>FLAPPY PRO</h3></div></div>
            <div class="g-btn" onclick="init('stack')"><span>üß±</span><div><h3>PERFECT STACK</h3></div></div>
            <div class="g-btn" onclick="init('knife')"><span>üéØ</span><div><h3>KNIFE HIT</h3></div></div>
        </div>
    </div>

    <div id="stage">
        <div class="hud">
            <button class="exit-ui" onclick="stop()">EXIT</button>
            <div class="score-ui" id="scr">0</div>
        </div>
        <div class="overlay"><h2 id="msg">TAP TO START</h2></div>
        <canvas id="c"></canvas>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        const canvas = document.getElementById('c');
        const ctx = canvas.getContext('2d', { alpha: false });
        const scrUi = document.getElementById('scr');
        const msgUi = document.getElementById('msg');
        
        let w, h, raf, mode, state = 'start', score = 0;
        let lastTime = 0, dt = 0;

        function resize() {
            w = canvas.width = window.innerWidth;
            h = canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resize); resize();

        function init(m) {
            mode = m; state = 'start'; score = 0;
            document.getElementById('menu').style.display = 'none';
            document.getElementById('stage').style.display = 'block';
            msgUi.innerText = "TAP TO START"; scrUi.innerText = "0";
            
            if(m === 'flappy') setupFlappy();
            if(m === 'stack') setupStack();
            if(m === 'knife') setupKnife();
            
            lastTime = performance.now();
            raf = requestAnimationFrame(loop);
        }

        function stop() {
            cancelAnimationFrame(raf);
            document.getElementById('menu').style.display = 'flex';
            document.getElementById('stage').style.display = 'none';
        }

        function loop(t) {
            dt = (t - lastTime) / 16.66;
            lastTime = t;
            ctx.fillStyle = '#08080a';
            ctx.fillRect(0,0,w,h);
            
            if(mode === 'flappy') updateFlappy(dt);
            if(mode === 'stack') updateStack(dt);
            if(mode === 'knife') updateKnife(dt);
            
            raf = requestAnimationFrame(loop);
        }

        // --- üê¶ FLAPPY PRO: PHYSICS ENGINE ---
        let bird, pipes;
        function setupFlappy() {
            bird = { y: h/2, v: 0, r: 18, targetRot: 0, curRot: 0 };
            pipes = [];
        }
        function updateFlappy(dt) {
            if(state === 'play') {
                bird.v += 0.5 * dt; bird.y += bird.v * dt;
                bird.targetRot = Math.min(Math.PI/4, Math.max(-Math.PI/4, bird.v * 0.1));
                bird.curRot += (bird.targetRot - bird.curRot) * 0.2;
                
                if(Math.floor(lastTime/1500) !== Math.floor((lastTime-16)/1500)) {
                    let gap = 170;
                    let hh = Math.random()*(h-gap-200)+100;
                    pipes.push({x: w, h: hh, gap: gap, p: false});
                }
                pipes.forEach(p => {
                    p.x -= 4 * dt;
                    ctx.fillStyle = '#1a1a20'; ctx.fillRect(p.x, 0, 60, p.h);
                    ctx.fillRect(p.x, p.h+p.gap, 60, h);
                    if(bird.x+bird.r > p.x && bird.x-bird.r < p.x+60 && (bird.y-bird.r < p.h || bird.y+bird.r > p.h+p.gap)) die();
                    if(p.x+60 < w*0.25 && !p.p) { score++; p.p = true; scrUi.innerText = score; tg.HapticFeedback.impactOccurred('light'); }
                });
                pipes = pipes.filter(p => p.x > -100);
                if(bird.y > h || bird.y < 0) die();
            }
            ctx.save(); ctx.translate(w*0.25, bird.y); ctx.rotate(bird.curRot);
            ctx.fillStyle = '#00f2ff'; ctx.beginPath(); ctx.arc(0,0,bird.r,0,Math.PI*2); ctx.fill();
            ctx.restore();
        }

        // --- üß± PERFECT STACK: TIMING ENGINE ---
        let blocks, curB, stackDir, stackSpeed;
        function setupStack() {
            blocks = [{x: (w-150)/2, y: h-100, w: 150, c: 200}];
            curB = {x: 0, y: h-135, w: 150, dir: 1, c: 210};
            stackSpeed = 5;
        }
        function updateStack(dt) {
            let camY = Math.max(0, (blocks.length * 35) - h/2);
            ctx.save(); ctx.translate(0, camY);
            blocks.forEach(b => {
                ctx.fillStyle = `hsl(${b.c}, 70%, 50%)`; ctx.fillRect(b.x, b.y, b.w, 35);
            });
            if(state === 'play') {
                curB.x += stackSpeed * curB.dir * dt;
                if(curB.x > w-curB.w || curB.x < 0) curB.dir *= -1;
                ctx.fillStyle = `hsl(${curB.c}, 70%, 50%)`; ctx.fillRect(curB.x, curB.y, curB.w, 35);
            }
            ctx.restore();
        }

        // --- üéØ KNIFE HIT: PRECISION ENGINE ---
        let log, kFire, kActiveY;
        function setupKnife() {
            log = { rot: 0, v: 0.04, knives: [], shake: 0 };
            kFire = false; kActiveY = h-150;
        }
        function updateKnife(dt) {
            if(log.shake > 0) { ctx.save(); ctx.translate(Math.random()*log.shake-log.shake/2, 0); log.shake *= 0.9; }
            log.rot += log.v * dt;
            ctx.save(); ctx.translate(w/2, 200); ctx.rotate(log.rot);
            ctx.fillStyle = '#222'; ctx.beginPath(); ctx.arc(0,0,80,0,Math.PI*2); ctx.fill();
            log.knives.forEach(a => {
                ctx.save(); ctx.rotate(a); ctx.fillStyle = '#fff'; ctx.fillRect(-4, 70, 8, 50); ctx.restore();
            });
            ctx.restore();
            if(!kFire) { ctx.fillStyle = '#fff'; ctx.fillRect(w/2-4, h-150, 8, 60); }
            else {
                kActiveY -= 25 * dt; ctx.fillStyle = '#fff'; ctx.fillRect(w/2-4, kActiveY, 8, 60);
                if(kActiveY < 280) {
                    let hitA = (Math.PI/2 - log.rot) % (Math.PI*2);
                    if(hitA < 0) hitA += Math.PI*2;
                    if(log.knives.some(a => Math.abs(a - hitA) < 0.25)) die();
                    else {
                        log.knives.push(hitA); score++; scrUi.innerText = score;
                        kFire = false; kActiveY = h-150; log.shake = 8;
                        tg.HapticFeedback.impactOccurred('medium');
                        log.v += 0.001;
                    }
                }
            }
            if(log.shake > 0) ctx.restore();
        }

        function die() {
            state = 'over'; msgUi.innerText = "GAME OVER";
            tg.HapticFeedback.notificationOccurred('error');
        }

        canvas.onmousedown = canvas.ontouchstart = (e) => {
            if(e.type === 'touchstart') e.preventDefault();
            if(state === 'over') { init(mode); return; }
            if(state === 'start') { state = 'play'; msgUi.innerText = ""; }
            
            if(mode === 'flappy') bird.v = -8;
            if(mode === 'knife' && !kFire) { kFire = true; tg.HapticFeedback.impactOccurred('soft'); }
            if(mode === 'stack') {
                let prev = blocks[blocks.length-1];
                let diff = curB.x - prev.x;
                if(Math.abs(diff) >= curB.w) die();
                else {
                    let newW = curB.w - Math.abs(diff);
                    let newX = diff > 0 ? curB.x : prev.x;
                    blocks.push({x: newX, y: curB.y, w: newW, c: 200+(score*10)});
                    score++; scrUi.innerText = score;
                    curB = {x: Math.random()*(w-newW), y: curB.y-35, w: newW, dir: 1, c: 200+(score*10)};
                    stackSpeed += 0.1; tg.HapticFeedback.impactOccurred('medium');
                }
            }
        };
    </script>
</body>
    </html>
    
