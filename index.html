<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Neon Cyber Domination</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;900&family=Syncopate:wght@700&display=swap');

        :root {
            --neon-blue: #00f2ff;
            --neon-pink: #ff00ff;
            --neon-gold: #ffd700;
            --bg-deep: #020205;
        }

        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            overflow: hidden; background: var(--bg-deep);
            font-family: 'Orbitron', sans-serif; color: #fff;
        }

        canvas { display: block; filter: saturate(1.5) contrast(1.2); }

        /* UI OVERLAY */
        #ui-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 10;
        }

        /* HUD - PULLAR VA SCORE */
        .hud-bar {
            position: absolute; top: 20px; left: 0; width: 100%;
            display: flex; justify-content: space-between; padding: 0 20px;
            box-sizing: border-box; pointer-events: auto;
        }

        .stat-item {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 242, 255, 0.3);
            padding: 8px 15px; border-radius: 12px;
            display: flex; align-items: center; gap: 10px;
            box-shadow: 0 0 15px rgba(0, 242, 255, 0.2);
        }

        .coin-val { color: var(--neon-gold); font-weight: 900; font-size: 20px; }

        /* MODAL SCREENS */
        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); backdrop-filter: blur(20px);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            pointer-events: auto; z-index: 100; transition: 0.5s;
        }

        h1 {
            font-family: 'Syncopate', sans-serif; font-size: 40px;
            text-transform: uppercase; letter-spacing: 10px; margin: 0;
            background: linear-gradient(to bottom, #fff, var(--neon-blue));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 0 15px var(--neon-blue));
        }

        .btn-main {
            background: var(--neon-blue); color: #000;
            border: none; padding: 20px 60px; font-size: 22px; font-weight: 900;
            margin-top: 40px; border-radius: 5px; cursor: pointer;
            clip-path: polygon(10% 0, 100% 0, 90% 100%, 0 100%);
            transition: 0.3s;
        }

        .btn-main:active { transform: scale(0.9); background: var(--neon-pink); }

        /* SHOP INTERFACE */
        #shop-modal { display: none; }
        .inventory-grid {
            display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;
            width: 90%; max-height: 50vh; overflow-y: auto; margin-top: 30px;
        }

        .skin-card {
            background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1);
            border-radius: 15px; padding: 15px; text-align: center;
            transition: 0.3s;
        }

        .skin-card.owned { border-color: var(--neon-blue); }
        .skin-card.equipped { background: rgba(0, 242, 255, 0.15); border-width: 2px; }

        .preview-circle {
            width: 50px; height: 50px; border-radius: 50%; margin: 0 auto 10px;
            box-shadow: 0 0 20px currentColor;
        }
    </style>
</head>
<body>

    <canvas id="gameCanvas"></canvas>

    <div id="ui-container">
        <div class="hud-bar">
            <div class="stat-item" onclick="toggleShop(true)">
                <span style="font-size: 22px;">ðŸ’°</span>
                <span id="balance" class="coin-val">0</span>
            </div>
            <div id="live-score" style="font-size: 45px; font-weight: 900; color: rgba(255,255,255,0.5);">0</div>
        </div>

        <div id="menu-screen" class="screen">
            <h1>NEON FLY</h1>
            <p style="color: #666; letter-spacing: 3px;">DOMINATION EDITION</p>
            <div style="margin-top: 20px;">BEST SCORE: <span id="high-score" style="color:var(--neon-pink)">0</span></div>
            <button class="btn-main" onclick="startGame()">INITIATE</button>
            <button onclick="toggleShop(true)" style="background:none; border:none; color:var(--neon-gold); margin-top:20px; font-weight:bold; cursor:pointer;">ACCESS MARKET</button>
        </div>

        <div id="shop-modal" class="screen">
            <h2 style="color: var(--neon-gold);">BLACK MARKET</h2>
            <div class="inventory-grid" id="skin-list"></div>
            <button class="btn-main" style="background:none; border:1px solid #fff; color:#fff; font-size:16px; padding:10px 30px;" onclick="toggleShop(false)">RETURN</button>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        let w, h, raf, state = 'MENU';

        // --- ECOSYSTEM DATA ---
        let User = {
            coins: parseInt(localStorage.getItem('neon_coins')) || 0,
            best: parseInt(localStorage.getItem('neon_best')) || 0,
            equipped: localStorage.getItem('neon_skin') || 'cyan',
            inventory: JSON.parse(localStorage.getItem('neon_inv')) || ['cyan']
        };

        const SKINS = {
            cyan: { color: '#00f2ff', price: 0, aura: 'rgba(0, 242, 255, 0.5)' },
            pink: { color: '#ff00ff', price: 100, aura: 'rgba(255, 0, 255, 0.5)' },
            gold: { color: '#ffd700', price: 500, aura: 'rgba(255, 215, 0, 0.8)' },
            glitch: { color: '#00ff00', price: 1000, aura: 'rgba(0, 255, 0, 0.9)' }
        };

        function save() {
            localStorage.setItem('neon_coins', User.coins);
            localStorage.setItem('neon_best', User.best);
            localStorage.setItem('neon_skin', User.equipped);
            localStorage.setItem('neon_inv', JSON.stringify(User.inventory));
            updateUI();
        }

        function updateUI() {
            document.getElementById('balance').innerText = User.coins;
            document.getElementById('high-score').innerText = User.best;
            renderShop();
        }
        
        // --- GAME LOGIC ---
        let bird = { x: 80, y: 0, v: 0, r: 18 };
        let pipes = [];
        let particles = [];
        let score = 0, frame = 0;

        function resize() {
            w = canvas.width = window.innerWidth;
            h = canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resize); resize();

        function startGame() {
            state = 'PLAY';
            document.getElementById('menu-screen').style.display = 'none';
            bird.y = h/2; bird.v = 0;
            pipes = []; particles = []; score = 0; frame = 0;
            loop();
        }

        function loop() {
            if(state !== 'PLAY') return;
            
            // Physics
            bird.v += 0.5; // Smooth gravity
            bird.y += bird.v;

            if(frame++ % 95 === 0) {
                let gap = 190;
                let top = Math.random() * (h - gap - 200) + 100;
                pipes.push({ x: w, t: top, g: gap, p: false });
            }

            // Draw
            ctx.fillStyle = '#020205'; ctx.fillRect(0,0,w,h);
            
            // Grid background (Full HD effect)
            ctx.strokeStyle = 'rgba(0, 242, 255, 0.05)';
            for(let i=0; i<w; i+=50) { ctx.beginPath(); ctx.moveTo(i, 0); ctx.lineTo(i, h); ctx.stroke(); }

            let skin = SKINS[User.equipped];

            // Particles
            if(frame % 2 === 0) particles.push({ x: bird.x-10, y: bird.y, r: Math.random()*5, a: 1, c: skin.color });
            particles.forEach((p, i) => {
                p.x -= 3; p.a -= 0.02;
                ctx.globalAlpha = p.a;
                ctx.shadowBlur = 10; ctx.shadowColor = p.c;
                ctx.fillStyle = p.c;
                ctx.beginPath(); ctx.arc(p.x, p.y, p.r, 0, Math.PI*2); ctx.fill();
                if(p.a <= 0) particles.splice(i, 1);
            });
            ctx.globalAlpha = 1; ctx.shadowBlur = 0;

            // Pipes
            pipes.forEach((p, i) => {
                p.x -= 4.5;
                ctx.fillStyle = '#0a0a1a';
                ctx.strokeStyle = skin.color;
                ctx.lineWidth = 3;
                ctx.shadowBlur = 15; ctx.shadowColor = skin.color;
                
                // Neon Pipes
                ctx.strokeRect(p.x, -10, 60, p.t+10);
                ctx.strokeRect(p.x, p.t+p.g, 60, h-(p.t+p.g)+10);
                ctx.shadowBlur = 0;

                // Collision
                if(bird.x+bird.r > p.x && bird.x-bird.r < p.x+60) {
                    if(bird.y-bird.r < p.t || bird.y+bird.r > p.t+p.g) endGame();
                }
                if(p.x+60 < bird.x && !p.p) {
                    score++; p.p = true;
                    document.getElementById('live-score').innerText = score;
                    tg.HapticFeedback.impactOccurred('medium');
                }
            });

            // Bird
            ctx.save();
            ctx.translate(bird.x, bird.y);
            ctx.rotate(Math.min(Math.PI/4, Math.max(-Math.PI/4, bird.v * 0.1)));
            ctx.shadowBlur = 30; ctx.shadowColor = skin.color;
            ctx.fillStyle = skin.color;
            ctx.beginPath(); ctx.arc(0,0,bird.r,0,Math.PI*2); ctx.fill();
            // HUD Eye
            ctx.fillStyle = '#fff'; ctx.beginPath(); ctx.arc(8,-5,6,0,Math.PI*2); ctx.fill();
            ctx.restore();

            if(pipes.length > 0 && pipes[0].x < -100) pipes.shift();
            if(bird.y > h || bird.y < 0) endGame();

            raf = requestAnimationFrame(loop);
        }

        function endGame() {
            state = 'MENU';
            cancelAnimationFrame(raf);
            tg.HapticFeedback.notificationOccurred('error');
            
            // Economy calculation
            User.coins += score;
            if(score > User.best) User.best = score;
            save();
            
            document.getElementById('menu-screen').style.display = 'flex';
        }

        // --- SHOP ENGINE ---
        function renderShop() {
            const container = document.getElementById('skin-list');
            container.innerHTML = '';
            Object.keys(SKINS).forEach(id => {
                const s = SKINS[id];
                const owned = User.inventory.includes(id);
                const equipped = User.equipped === id;
                
                const card = document.createElement('div');
                card.className = `skin-card ${owned ? 'owned' : ''} ${equipped ? 'equipped' : ''}`;
                card.innerHTML = `
                    <div class="preview-circle" style="background:${s.color}; color:${s.color}"></div>
                    <div style="font-weight:bold; font-size:12px;">${id.toUpperCase()}</div>
                    <button onclick="handlePurchase('${id}')" style="margin-top:10px; width:100%; border-radius:5px; border:none; padding:5px; background:${equipped?'#0f0':(owned?'#fff':'#ffd700')}; font-weight:bold;">
                        ${equipped ? 'ACTIVE' : (owned ? 'EQUIP' : s.price + ' ðŸ’°')}
                    </button>
                `;
                container.appendChild(card);
            });
        }

        function handlePurchase(id) {
            const s = SKINS[id];
            if(User.inventory.includes(id)) {
                User.equipped = id;
            } else if(User.coins >= s.price) {
                User.coins -= s.price;
                User.inventory.push(id);
                User.equipped = id;
                tg.HapticFeedback.notificationOccurred('success');
            } else {
                alert("Mablag' yetarli emas!");
            }
            save();
        }

        function toggleShop(show) {
            document.getElementById('shop-modal').style.display = show ? 'flex' : 'none';
        }

        // Input
        const jump = (e) => { if(e) e.preventDefault(); if(state==='PLAY') bird.v = -8; };
        window.addEventListener('mousedown', jump);
        window.addEventListener('touchstart', jump, {passive:false});

        updateUI();
    </script>
</body>
</html>
